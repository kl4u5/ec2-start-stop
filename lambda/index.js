"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_ec2_1 = require("@aws-sdk/client-ec2");
const client_ssm_1 = require("@aws-sdk/client-ssm");
const ec2Client = new client_ec2_1.EC2Client({});
const ssmClient = new client_ssm_1.SSMClient({});
const SCHEDULES_PARAMETER_NAME = process.env.SCHEDULES_PARAMETER_NAME || '/ec2-start-stop/schedules';
const TOLERANCE_MINUTES = 2;
const handler = async (event) => {
    console.log('Starting EC2 start/stop scheduler...');
    try {
        // Get schedules configuration from Parameter Store
        const schedulesConfig = await getSchedulesConfig();
        console.log(`Found ${schedulesConfig.schedules.length} schedule(s)`);
        // Get all EC2 instances with the start-stop-schedule tag
        const instances = await getTaggedInstances();
        console.log(`Found ${instances.length} tagged instance(s)`);
        if (instances.length === 0) {
            console.log('No instances found with start-stop-schedule tag');
            return;
        }
        // Process each instance
        for (const instance of instances) {
            await processInstance(instance, schedulesConfig);
        }
        console.log('EC2 start/stop scheduler completed successfully');
    }
    catch (error) {
        console.error('Error in EC2 start/stop scheduler:', error);
        throw error;
    }
};
exports.handler = handler;
async function getSchedulesConfig() {
    const command = new client_ssm_1.GetParameterCommand({
        Name: SCHEDULES_PARAMETER_NAME,
    });
    const response = await ssmClient.send(command);
    if (!response.Parameter?.Value) {
        throw new Error('Schedules configuration not found in Parameter Store');
    }
    return JSON.parse(response.Parameter.Value);
}
async function getTaggedInstances() {
    const command = new client_ec2_1.DescribeInstancesCommand({
        Filters: [
            {
                Name: 'tag-key',
                Values: ['start-stop-schedule'],
            },
        ],
    });
    const response = await ec2Client.send(command);
    const instances = [];
    if (response.Reservations) {
        for (const reservation of response.Reservations) {
            if (reservation.Instances) {
                instances.push(...reservation.Instances);
            }
        }
    }
    return instances;
}
async function processInstance(instance, schedulesConfig) {
    if (!instance.InstanceId || !instance.Tags) {
        console.log('Instance missing ID or tags, skipping');
        return;
    }
    // Find the schedule tag value
    const scheduleTag = instance.Tags.find(tag => tag.Key === 'start-stop-schedule');
    if (!scheduleTag?.Value) {
        console.log(`Instance ${instance.InstanceId} has no schedule tag value, skipping`);
        return;
    }
    // Find matching schedule (case insensitive, trimmed)
    const scheduleName = scheduleTag.Value.trim().toLowerCase();
    const schedule = schedulesConfig.schedules.find(s => s.name.toLowerCase() === scheduleName);
    if (!schedule) {
        console.log(`Instance ${instance.InstanceId} references unknown schedule '${scheduleTag.Value}', skipping`);
        return;
    }
    if (!schedule.enabled) {
        console.log(`Instance ${instance.InstanceId} schedule '${schedule.name}' is disabled, skipping`);
        return;
    }
    console.log(`Processing instance ${instance.InstanceId} with schedule '${schedule.name}'`);
    // Get current time in the schedule's timezone
    const now = new Date();
    const timeInTimezone = new Date(now.toLocaleString('en-US', { timeZone: schedule.timezone }));
    // Get current weekday (0 = Sunday, 1 = Monday, etc.)
    const weekday = timeInTimezone.getDay();
    const weekdayKeys = ['su', 'mo', 'tu', 'we', 'th', 'fr', 'sa'];
    const weekdayKey = weekdayKeys[weekday];
    // Get the schedule for today
    let daySchedule = schedule[weekdayKey];
    if (!daySchedule && schedule.default) {
        daySchedule = schedule.default;
    }
    if (!daySchedule) {
        console.log(`Instance ${instance.InstanceId} has no schedule for ${weekdayKey}, skipping`);
        return;
    }
    // Parse the day schedule (format: "start;stop" or "never;stop" or "start;never")
    const timeActions = parseDaySchedule(daySchedule);
    // Check if any action should be triggered now
    const currentTime = `${timeInTimezone.getHours().toString().padStart(2, '0')}:${timeInTimezone.getMinutes().toString().padStart(2, '0')}`;
    for (const timeAction of timeActions) {
        if (shouldTriggerAction(currentTime, timeAction.time)) {
            await executeAction(instance, timeAction.action);
        }
    }
}
function parseDaySchedule(schedule) {
    const actions = [];
    // Handle different separators (, or ;)
    const parts = schedule.includes(';') ? schedule.split(';') : schedule.split(',');
    if (parts.length === 2) {
        const [startTime, stopTime] = parts.map(p => p.trim());
        if (startTime !== 'never' && startTime) {
            actions.push({ time: startTime, action: 'start' });
        }
        if (stopTime !== 'never' && stopTime) {
            actions.push({ time: stopTime, action: 'stop' });
        }
    }
    return actions;
}
function shouldTriggerAction(currentTime, scheduledTime) {
    const [currentHour, currentMinute] = currentTime.split(':').map(Number);
    const [scheduledHour, scheduledMinute] = scheduledTime.split(':').map(Number);
    const currentTotalMinutes = currentHour * 60 + currentMinute;
    const scheduledTotalMinutes = scheduledHour * 60 + scheduledMinute;
    const diff = Math.abs(currentTotalMinutes - scheduledTotalMinutes);
    return diff <= TOLERANCE_MINUTES;
}
async function executeAction(instance, action) {
    if (!instance.InstanceId) {
        return;
    }
    const instanceState = instance.State?.Name;
    console.log(`Instance ${instance.InstanceId} current state: ${instanceState}, requested action: ${action}`);
    if (action === 'start' && (instanceState === 'stopped' || instanceState === 'stopping')) {
        console.log(`Starting instance ${instance.InstanceId}`);
        const command = new client_ec2_1.StartInstancesCommand({
            InstanceIds: [instance.InstanceId],
        });
        try {
            await ec2Client.send(command);
            console.log(`Successfully started instance ${instance.InstanceId}`);
        }
        catch (error) {
            console.error(`Failed to start instance ${instance.InstanceId}:`, error);
        }
    }
    else if (action === 'stop' && (instanceState === 'running' || instanceState === 'pending')) {
        console.log(`Stopping instance ${instance.InstanceId}`);
        const command = new client_ec2_1.StopInstancesCommand({
            InstanceIds: [instance.InstanceId],
        });
        try {
            await ec2Client.send(command);
            console.log(`Successfully stopped instance ${instance.InstanceId}`);
        }
        catch (error) {
            console.error(`Failed to stop instance ${instance.InstanceId}:`, error);
        }
    }
    else {
        console.log(`Instance ${instance.InstanceId} already in correct state for action ${action} (current: ${instanceState})`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvREFBaUk7QUFDakksb0RBQXFFO0FBMEJyRSxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDcEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBRXBDLE1BQU0sd0JBQXdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsSUFBSSwyQkFBMkIsQ0FBQztBQUNyRyxNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQztBQUVyQixNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFpQixFQUFFO0lBQ3pELE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLENBQUMsQ0FBQztJQUVwRCxJQUFJLENBQUM7UUFDSCxtREFBbUQ7UUFDbkQsTUFBTSxlQUFlLEdBQUcsTUFBTSxrQkFBa0IsRUFBRSxDQUFDO1FBQ25ELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxlQUFlLENBQUMsU0FBUyxDQUFDLE1BQU0sY0FBYyxDQUFDLENBQUM7UUFFckUseURBQXlEO1FBQ3pELE1BQU0sU0FBUyxHQUFHLE1BQU0sa0JBQWtCLEVBQUUsQ0FBQztRQUM3QyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsU0FBUyxDQUFDLE1BQU0scUJBQXFCLENBQUMsQ0FBQztRQUU1RCxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO1lBQy9ELE9BQU87UUFDVCxDQUFDO1FBRUQsd0JBQXdCO1FBQ3hCLEtBQUssTUFBTSxRQUFRLElBQUksU0FBUyxFQUFFLENBQUM7WUFDakMsTUFBTSxlQUFlLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ25ELENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG9DQUFvQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNELE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQztBQTNCVyxRQUFBLE9BQU8sV0EyQmxCO0FBRUYsS0FBSyxVQUFVLGtCQUFrQjtJQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFJLGdDQUFtQixDQUFDO1FBQ3RDLElBQUksRUFBRSx3QkFBd0I7S0FDL0IsQ0FBQyxDQUFDO0lBRUgsTUFBTSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRS9DLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDO1FBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsc0RBQXNELENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDOUMsQ0FBQztBQUVELEtBQUssVUFBVSxrQkFBa0I7SUFDL0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxxQ0FBd0IsQ0FBQztRQUMzQyxPQUFPLEVBQUU7WUFDUDtnQkFDRSxJQUFJLEVBQUUsU0FBUztnQkFDZixNQUFNLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQzthQUNoQztTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLE1BQU0sU0FBUyxHQUFlLEVBQUUsQ0FBQztJQUVqQyxJQUFJLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxQixLQUFLLE1BQU0sV0FBVyxJQUFJLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNoRCxJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDMUIsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMzQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsS0FBSyxVQUFVLGVBQWUsQ0FBQyxRQUFrQixFQUFFLGVBQWdDO0lBQ2pGLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUNBQXVDLENBQUMsQ0FBQztRQUNyRCxPQUFPO0lBQ1QsQ0FBQztJQUVELDhCQUE4QjtJQUM5QixNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUsscUJBQXFCLENBQUMsQ0FBQztJQUNqRixJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxDQUFDO1FBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxRQUFRLENBQUMsVUFBVSxzQ0FBc0MsQ0FBQyxDQUFDO1FBQ25GLE9BQU87SUFDVCxDQUFDO0lBRUQscURBQXFEO0lBQ3JELE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDNUQsTUFBTSxRQUFRLEdBQUcsZUFBZSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLFlBQVksQ0FBQyxDQUFDO0lBRTVGLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxRQUFRLENBQUMsVUFBVSxpQ0FBaUMsV0FBVyxDQUFDLEtBQUssYUFBYSxDQUFDLENBQUM7UUFDNUcsT0FBTztJQUNULENBQUM7SUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxRQUFRLENBQUMsVUFBVSxjQUFjLFFBQVEsQ0FBQyxJQUFJLHlCQUF5QixDQUFDLENBQUM7UUFDakcsT0FBTztJQUNULENBQUM7SUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixRQUFRLENBQUMsVUFBVSxtQkFBbUIsUUFBUSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7SUFFM0YsOENBQThDO0lBQzlDLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDdkIsTUFBTSxjQUFjLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUU5RixxREFBcUQ7SUFDckQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3hDLE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDL0QsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBbUIsQ0FBQztJQUUxRCw2QkFBNkI7SUFDN0IsSUFBSSxXQUFXLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBdUIsQ0FBQztJQUM3RCxJQUFJLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyQyxXQUFXLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQztJQUNqQyxDQUFDO0lBRUQsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxRQUFRLENBQUMsVUFBVSx3QkFBd0IsVUFBVSxZQUFZLENBQUMsQ0FBQztRQUMzRixPQUFPO0lBQ1QsQ0FBQztJQUVELGlGQUFpRjtJQUNqRixNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUVsRCw4Q0FBOEM7SUFDOUMsTUFBTSxXQUFXLEdBQUcsR0FBRyxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsSUFBSSxjQUFjLENBQUMsVUFBVSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO0lBRTFJLEtBQUssTUFBTSxVQUFVLElBQUksV0FBVyxFQUFFLENBQUM7UUFDckMsSUFBSSxtQkFBbUIsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDdEQsTUFBTSxhQUFhLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNuRCxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLFFBQWdCO0lBQ3hDLE1BQU0sT0FBTyxHQUFpQixFQUFFLENBQUM7SUFFakMsdUNBQXVDO0lBQ3ZDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFakYsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXZELElBQUksU0FBUyxLQUFLLE9BQU8sSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUN2QyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBRUQsSUFBSSxRQUFRLEtBQUssT0FBTyxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ3JDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELENBQUM7SUFDSCxDQUFDO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsV0FBbUIsRUFBRSxhQUFxQjtJQUNyRSxNQUFNLENBQUMsV0FBVyxFQUFFLGFBQWEsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hFLE1BQU0sQ0FBQyxhQUFhLEVBQUUsZUFBZSxDQUFDLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFOUUsTUFBTSxtQkFBbUIsR0FBRyxXQUFXLEdBQUcsRUFBRSxHQUFHLGFBQWEsQ0FBQztJQUM3RCxNQUFNLHFCQUFxQixHQUFHLGFBQWEsR0FBRyxFQUFFLEdBQUcsZUFBZSxDQUFDO0lBRW5FLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEdBQUcscUJBQXFCLENBQUMsQ0FBQztJQUVuRSxPQUFPLElBQUksSUFBSSxpQkFBaUIsQ0FBQztBQUNuQyxDQUFDO0FBRUQsS0FBSyxVQUFVLGFBQWEsQ0FBQyxRQUFrQixFQUFFLE1BQXdCO0lBQ3ZFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDekIsT0FBTztJQUNULENBQUM7SUFFRCxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQztJQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksUUFBUSxDQUFDLFVBQVUsbUJBQW1CLGFBQWEsdUJBQXVCLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFFNUcsSUFBSSxNQUFNLEtBQUssT0FBTyxJQUFJLENBQUMsYUFBYSxLQUFLLFNBQVMsSUFBSSxhQUFhLEtBQUssVUFBVSxDQUFDLEVBQUUsQ0FBQztRQUN4RixPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixRQUFRLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUV4RCxNQUFNLE9BQU8sR0FBRyxJQUFJLGtDQUFxQixDQUFDO1lBQ3hDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7U0FDbkMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDO1lBQ0gsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsUUFBUSxDQUFDLFVBQVUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNFLENBQUM7SUFDSCxDQUFDO1NBQU0sSUFBSSxNQUFNLEtBQUssTUFBTSxJQUFJLENBQUMsYUFBYSxLQUFLLFNBQVMsSUFBSSxhQUFhLEtBQUssU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUM3RixPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixRQUFRLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUV4RCxNQUFNLE9BQU8sR0FBRyxJQUFJLGlDQUFvQixDQUFDO1lBQ3ZDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7U0FDbkMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDO1lBQ0gsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsUUFBUSxDQUFDLFVBQVUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFFLENBQUM7SUFDSCxDQUFDO1NBQU0sQ0FBQztRQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxRQUFRLENBQUMsVUFBVSx3Q0FBd0MsTUFBTSxjQUFjLGFBQWEsR0FBRyxDQUFDLENBQUM7SUFDM0gsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFQzJDbGllbnQsIERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCwgU3RhcnRJbnN0YW5jZXNDb21tYW5kLCBTdG9wSW5zdGFuY2VzQ29tbWFuZCwgSW5zdGFuY2UgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZWMyJztcclxuaW1wb3J0IHsgU1NNQ2xpZW50LCBHZXRQYXJhbWV0ZXJDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNzbSc7XHJcblxyXG5pbnRlcmZhY2UgU2NoZWR1bGUge1xyXG4gIG5hbWU6IHN0cmluZztcclxuICBlbmFibGVkOiBib29sZWFuO1xyXG4gIHRpbWV6b25lOiBzdHJpbmc7XHJcbiAgbW8/OiBzdHJpbmc7XHJcbiAgdHU/OiBzdHJpbmc7XHJcbiAgd2U/OiBzdHJpbmc7XHJcbiAgdGg/OiBzdHJpbmc7XHJcbiAgZnI/OiBzdHJpbmc7XHJcbiAgc2E/OiBzdHJpbmc7XHJcbiAgc3U/OiBzdHJpbmc7XHJcbiAgZGVmYXVsdD86IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFNjaGVkdWxlc0NvbmZpZyB7XHJcbiAgc2NoZWR1bGVzOiBTY2hlZHVsZVtdO1xyXG4gIG1haW50YWluZXJzOiBzdHJpbmdbXTtcclxufVxyXG5cclxuaW50ZXJmYWNlIFRpbWVBY3Rpb24ge1xyXG4gIHRpbWU6IHN0cmluZztcclxuICBhY3Rpb246ICdzdGFydCcgfCAnc3RvcCc7XHJcbn1cclxuXHJcbmNvbnN0IGVjMkNsaWVudCA9IG5ldyBFQzJDbGllbnQoe30pO1xyXG5jb25zdCBzc21DbGllbnQgPSBuZXcgU1NNQ2xpZW50KHt9KTtcclxuXHJcbmNvbnN0IFNDSEVEVUxFU19QQVJBTUVURVJfTkFNRSA9IHByb2Nlc3MuZW52LlNDSEVEVUxFU19QQVJBTUVURVJfTkFNRSB8fCAnL2VjMi1zdGFydC1zdG9wL3NjaGVkdWxlcyc7XHJcbmNvbnN0IFRPTEVSQU5DRV9NSU5VVEVTID0gMjtcclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnkpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICBjb25zb2xlLmxvZygnU3RhcnRpbmcgRUMyIHN0YXJ0L3N0b3Agc2NoZWR1bGVyLi4uJyk7XHJcbiAgXHJcbiAgdHJ5IHtcclxuICAgIC8vIEdldCBzY2hlZHVsZXMgY29uZmlndXJhdGlvbiBmcm9tIFBhcmFtZXRlciBTdG9yZVxyXG4gICAgY29uc3Qgc2NoZWR1bGVzQ29uZmlnID0gYXdhaXQgZ2V0U2NoZWR1bGVzQ29uZmlnKCk7XHJcbiAgICBjb25zb2xlLmxvZyhgRm91bmQgJHtzY2hlZHVsZXNDb25maWcuc2NoZWR1bGVzLmxlbmd0aH0gc2NoZWR1bGUocylgKTtcclxuXHJcbiAgICAvLyBHZXQgYWxsIEVDMiBpbnN0YW5jZXMgd2l0aCB0aGUgc3RhcnQtc3RvcC1zY2hlZHVsZSB0YWdcclxuICAgIGNvbnN0IGluc3RhbmNlcyA9IGF3YWl0IGdldFRhZ2dlZEluc3RhbmNlcygpO1xyXG4gICAgY29uc29sZS5sb2coYEZvdW5kICR7aW5zdGFuY2VzLmxlbmd0aH0gdGFnZ2VkIGluc3RhbmNlKHMpYCk7XHJcblxyXG4gICAgaWYgKGluc3RhbmNlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgY29uc29sZS5sb2coJ05vIGluc3RhbmNlcyBmb3VuZCB3aXRoIHN0YXJ0LXN0b3Atc2NoZWR1bGUgdGFnJyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQcm9jZXNzIGVhY2ggaW5zdGFuY2VcclxuICAgIGZvciAoY29uc3QgaW5zdGFuY2Ugb2YgaW5zdGFuY2VzKSB7XHJcbiAgICAgIGF3YWl0IHByb2Nlc3NJbnN0YW5jZShpbnN0YW5jZSwgc2NoZWR1bGVzQ29uZmlnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZygnRUMyIHN0YXJ0L3N0b3Agc2NoZWR1bGVyIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHknKTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gRUMyIHN0YXJ0L3N0b3Agc2NoZWR1bGVyOicsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufTtcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldFNjaGVkdWxlc0NvbmZpZygpOiBQcm9taXNlPFNjaGVkdWxlc0NvbmZpZz4ge1xyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0UGFyYW1ldGVyQ29tbWFuZCh7XHJcbiAgICBOYW1lOiBTQ0hFRFVMRVNfUEFSQU1FVEVSX05BTUUsXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc3NtQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgXHJcbiAgaWYgKCFyZXNwb25zZS5QYXJhbWV0ZXI/LlZhbHVlKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1NjaGVkdWxlcyBjb25maWd1cmF0aW9uIG5vdCBmb3VuZCBpbiBQYXJhbWV0ZXIgU3RvcmUnKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBKU09OLnBhcnNlKHJlc3BvbnNlLlBhcmFtZXRlci5WYWx1ZSk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldFRhZ2dlZEluc3RhbmNlcygpOiBQcm9taXNlPEluc3RhbmNlW10+IHtcclxuICBjb25zdCBjb21tYW5kID0gbmV3IERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCh7XHJcbiAgICBGaWx0ZXJzOiBbXHJcbiAgICAgIHtcclxuICAgICAgICBOYW1lOiAndGFnLWtleScsXHJcbiAgICAgICAgVmFsdWVzOiBbJ3N0YXJ0LXN0b3Atc2NoZWR1bGUnXSxcclxuICAgICAgfSxcclxuICAgIF0sXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZWMyQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgY29uc3QgaW5zdGFuY2VzOiBJbnN0YW5jZVtdID0gW107XHJcblxyXG4gIGlmIChyZXNwb25zZS5SZXNlcnZhdGlvbnMpIHtcclxuICAgIGZvciAoY29uc3QgcmVzZXJ2YXRpb24gb2YgcmVzcG9uc2UuUmVzZXJ2YXRpb25zKSB7XHJcbiAgICAgIGlmIChyZXNlcnZhdGlvbi5JbnN0YW5jZXMpIHtcclxuICAgICAgICBpbnN0YW5jZXMucHVzaCguLi5yZXNlcnZhdGlvbi5JbnN0YW5jZXMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gaW5zdGFuY2VzO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzSW5zdGFuY2UoaW5zdGFuY2U6IEluc3RhbmNlLCBzY2hlZHVsZXNDb25maWc6IFNjaGVkdWxlc0NvbmZpZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGlmICghaW5zdGFuY2UuSW5zdGFuY2VJZCB8fCAhaW5zdGFuY2UuVGFncykge1xyXG4gICAgY29uc29sZS5sb2coJ0luc3RhbmNlIG1pc3NpbmcgSUQgb3IgdGFncywgc2tpcHBpbmcnKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIC8vIEZpbmQgdGhlIHNjaGVkdWxlIHRhZyB2YWx1ZVxyXG4gIGNvbnN0IHNjaGVkdWxlVGFnID0gaW5zdGFuY2UuVGFncy5maW5kKHRhZyA9PiB0YWcuS2V5ID09PSAnc3RhcnQtc3RvcC1zY2hlZHVsZScpO1xyXG4gIGlmICghc2NoZWR1bGVUYWc/LlZhbHVlKSB7XHJcbiAgICBjb25zb2xlLmxvZyhgSW5zdGFuY2UgJHtpbnN0YW5jZS5JbnN0YW5jZUlkfSBoYXMgbm8gc2NoZWR1bGUgdGFnIHZhbHVlLCBza2lwcGluZ2ApO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgLy8gRmluZCBtYXRjaGluZyBzY2hlZHVsZSAoY2FzZSBpbnNlbnNpdGl2ZSwgdHJpbW1lZClcclxuICBjb25zdCBzY2hlZHVsZU5hbWUgPSBzY2hlZHVsZVRhZy5WYWx1ZS50cmltKCkudG9Mb3dlckNhc2UoKTtcclxuICBjb25zdCBzY2hlZHVsZSA9IHNjaGVkdWxlc0NvbmZpZy5zY2hlZHVsZXMuZmluZChzID0+IHMubmFtZS50b0xvd2VyQ2FzZSgpID09PSBzY2hlZHVsZU5hbWUpO1xyXG5cclxuICBpZiAoIXNjaGVkdWxlKSB7XHJcbiAgICBjb25zb2xlLmxvZyhgSW5zdGFuY2UgJHtpbnN0YW5jZS5JbnN0YW5jZUlkfSByZWZlcmVuY2VzIHVua25vd24gc2NoZWR1bGUgJyR7c2NoZWR1bGVUYWcuVmFsdWV9Jywgc2tpcHBpbmdgKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIGlmICghc2NoZWR1bGUuZW5hYmxlZCkge1xyXG4gICAgY29uc29sZS5sb2coYEluc3RhbmNlICR7aW5zdGFuY2UuSW5zdGFuY2VJZH0gc2NoZWR1bGUgJyR7c2NoZWR1bGUubmFtZX0nIGlzIGRpc2FibGVkLCBza2lwcGluZ2ApO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgaW5zdGFuY2UgJHtpbnN0YW5jZS5JbnN0YW5jZUlkfSB3aXRoIHNjaGVkdWxlICcke3NjaGVkdWxlLm5hbWV9J2ApO1xyXG5cclxuICAvLyBHZXQgY3VycmVudCB0aW1lIGluIHRoZSBzY2hlZHVsZSdzIHRpbWV6b25lXHJcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcclxuICBjb25zdCB0aW1lSW5UaW1lem9uZSA9IG5ldyBEYXRlKG5vdy50b0xvY2FsZVN0cmluZygnZW4tVVMnLCB7IHRpbWVab25lOiBzY2hlZHVsZS50aW1lem9uZSB9KSk7XHJcbiAgXHJcbiAgLy8gR2V0IGN1cnJlbnQgd2Vla2RheSAoMCA9IFN1bmRheSwgMSA9IE1vbmRheSwgZXRjLilcclxuICBjb25zdCB3ZWVrZGF5ID0gdGltZUluVGltZXpvbmUuZ2V0RGF5KCk7XHJcbiAgY29uc3Qgd2Vla2RheUtleXMgPSBbJ3N1JywgJ21vJywgJ3R1JywgJ3dlJywgJ3RoJywgJ2ZyJywgJ3NhJ107XHJcbiAgY29uc3Qgd2Vla2RheUtleSA9IHdlZWtkYXlLZXlzW3dlZWtkYXldIGFzIGtleW9mIFNjaGVkdWxlO1xyXG5cclxuICAvLyBHZXQgdGhlIHNjaGVkdWxlIGZvciB0b2RheVxyXG4gIGxldCBkYXlTY2hlZHVsZSA9IHNjaGVkdWxlW3dlZWtkYXlLZXldIGFzIHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICBpZiAoIWRheVNjaGVkdWxlICYmIHNjaGVkdWxlLmRlZmF1bHQpIHtcclxuICAgIGRheVNjaGVkdWxlID0gc2NoZWR1bGUuZGVmYXVsdDtcclxuICB9XHJcblxyXG4gIGlmICghZGF5U2NoZWR1bGUpIHtcclxuICAgIGNvbnNvbGUubG9nKGBJbnN0YW5jZSAke2luc3RhbmNlLkluc3RhbmNlSWR9IGhhcyBubyBzY2hlZHVsZSBmb3IgJHt3ZWVrZGF5S2V5fSwgc2tpcHBpbmdgKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIC8vIFBhcnNlIHRoZSBkYXkgc2NoZWR1bGUgKGZvcm1hdDogXCJzdGFydDtzdG9wXCIgb3IgXCJuZXZlcjtzdG9wXCIgb3IgXCJzdGFydDtuZXZlclwiKVxyXG4gIGNvbnN0IHRpbWVBY3Rpb25zID0gcGFyc2VEYXlTY2hlZHVsZShkYXlTY2hlZHVsZSk7XHJcbiAgXHJcbiAgLy8gQ2hlY2sgaWYgYW55IGFjdGlvbiBzaG91bGQgYmUgdHJpZ2dlcmVkIG5vd1xyXG4gIGNvbnN0IGN1cnJlbnRUaW1lID0gYCR7dGltZUluVGltZXpvbmUuZ2V0SG91cnMoKS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9OiR7dGltZUluVGltZXpvbmUuZ2V0TWludXRlcygpLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gO1xyXG4gIFxyXG4gIGZvciAoY29uc3QgdGltZUFjdGlvbiBvZiB0aW1lQWN0aW9ucykge1xyXG4gICAgaWYgKHNob3VsZFRyaWdnZXJBY3Rpb24oY3VycmVudFRpbWUsIHRpbWVBY3Rpb24udGltZSkpIHtcclxuICAgICAgYXdhaXQgZXhlY3V0ZUFjdGlvbihpbnN0YW5jZSwgdGltZUFjdGlvbi5hY3Rpb24pO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VEYXlTY2hlZHVsZShzY2hlZHVsZTogc3RyaW5nKTogVGltZUFjdGlvbltdIHtcclxuICBjb25zdCBhY3Rpb25zOiBUaW1lQWN0aW9uW10gPSBbXTtcclxuICBcclxuICAvLyBIYW5kbGUgZGlmZmVyZW50IHNlcGFyYXRvcnMgKCwgb3IgOylcclxuICBjb25zdCBwYXJ0cyA9IHNjaGVkdWxlLmluY2x1ZGVzKCc7JykgPyBzY2hlZHVsZS5zcGxpdCgnOycpIDogc2NoZWR1bGUuc3BsaXQoJywnKTtcclxuICBcclxuICBpZiAocGFydHMubGVuZ3RoID09PSAyKSB7XHJcbiAgICBjb25zdCBbc3RhcnRUaW1lLCBzdG9wVGltZV0gPSBwYXJ0cy5tYXAocCA9PiBwLnRyaW0oKSk7XHJcbiAgICBcclxuICAgIGlmIChzdGFydFRpbWUgIT09ICduZXZlcicgJiYgc3RhcnRUaW1lKSB7XHJcbiAgICAgIGFjdGlvbnMucHVzaCh7IHRpbWU6IHN0YXJ0VGltZSwgYWN0aW9uOiAnc3RhcnQnIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAoc3RvcFRpbWUgIT09ICduZXZlcicgJiYgc3RvcFRpbWUpIHtcclxuICAgICAgYWN0aW9ucy5wdXNoKHsgdGltZTogc3RvcFRpbWUsIGFjdGlvbjogJ3N0b3AnIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGFjdGlvbnM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNob3VsZFRyaWdnZXJBY3Rpb24oY3VycmVudFRpbWU6IHN0cmluZywgc2NoZWR1bGVkVGltZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgY29uc3QgW2N1cnJlbnRIb3VyLCBjdXJyZW50TWludXRlXSA9IGN1cnJlbnRUaW1lLnNwbGl0KCc6JykubWFwKE51bWJlcik7XHJcbiAgY29uc3QgW3NjaGVkdWxlZEhvdXIsIHNjaGVkdWxlZE1pbnV0ZV0gPSBzY2hlZHVsZWRUaW1lLnNwbGl0KCc6JykubWFwKE51bWJlcik7XHJcblxyXG4gIGNvbnN0IGN1cnJlbnRUb3RhbE1pbnV0ZXMgPSBjdXJyZW50SG91ciAqIDYwICsgY3VycmVudE1pbnV0ZTtcclxuICBjb25zdCBzY2hlZHVsZWRUb3RhbE1pbnV0ZXMgPSBzY2hlZHVsZWRIb3VyICogNjAgKyBzY2hlZHVsZWRNaW51dGU7XHJcblxyXG4gIGNvbnN0IGRpZmYgPSBNYXRoLmFicyhjdXJyZW50VG90YWxNaW51dGVzIC0gc2NoZWR1bGVkVG90YWxNaW51dGVzKTtcclxuICBcclxuICByZXR1cm4gZGlmZiA8PSBUT0xFUkFOQ0VfTUlOVVRFUztcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZUFjdGlvbihpbnN0YW5jZTogSW5zdGFuY2UsIGFjdGlvbjogJ3N0YXJ0JyB8ICdzdG9wJyk6IFByb21pc2U8dm9pZD4ge1xyXG4gIGlmICghaW5zdGFuY2UuSW5zdGFuY2VJZCkge1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgaW5zdGFuY2VTdGF0ZSA9IGluc3RhbmNlLlN0YXRlPy5OYW1lO1xyXG4gIGNvbnNvbGUubG9nKGBJbnN0YW5jZSAke2luc3RhbmNlLkluc3RhbmNlSWR9IGN1cnJlbnQgc3RhdGU6ICR7aW5zdGFuY2VTdGF0ZX0sIHJlcXVlc3RlZCBhY3Rpb246ICR7YWN0aW9ufWApO1xyXG5cclxuICBpZiAoYWN0aW9uID09PSAnc3RhcnQnICYmIChpbnN0YW5jZVN0YXRlID09PSAnc3RvcHBlZCcgfHwgaW5zdGFuY2VTdGF0ZSA9PT0gJ3N0b3BwaW5nJykpIHtcclxuICAgIGNvbnNvbGUubG9nKGBTdGFydGluZyBpbnN0YW5jZSAke2luc3RhbmNlLkluc3RhbmNlSWR9YCk7XHJcbiAgICBcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgU3RhcnRJbnN0YW5jZXNDb21tYW5kKHtcclxuICAgICAgSW5zdGFuY2VJZHM6IFtpbnN0YW5jZS5JbnN0YW5jZUlkXSxcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCBlYzJDbGllbnQuc2VuZChjb21tYW5kKTtcclxuICAgICAgY29uc29sZS5sb2coYFN1Y2Nlc3NmdWxseSBzdGFydGVkIGluc3RhbmNlICR7aW5zdGFuY2UuSW5zdGFuY2VJZH1gKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBzdGFydCBpbnN0YW5jZSAke2luc3RhbmNlLkluc3RhbmNlSWR9OmAsIGVycm9yKTtcclxuICAgIH1cclxuICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3N0b3AnICYmIChpbnN0YW5jZVN0YXRlID09PSAncnVubmluZycgfHwgaW5zdGFuY2VTdGF0ZSA9PT0gJ3BlbmRpbmcnKSkge1xyXG4gICAgY29uc29sZS5sb2coYFN0b3BwaW5nIGluc3RhbmNlICR7aW5zdGFuY2UuSW5zdGFuY2VJZH1gKTtcclxuICAgIFxyXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTdG9wSW5zdGFuY2VzQ29tbWFuZCh7XHJcbiAgICAgIEluc3RhbmNlSWRzOiBbaW5zdGFuY2UuSW5zdGFuY2VJZF0sXHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgZWMyQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgc3RvcHBlZCBpbnN0YW5jZSAke2luc3RhbmNlLkluc3RhbmNlSWR9YCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gc3RvcCBpbnN0YW5jZSAke2luc3RhbmNlLkluc3RhbmNlSWR9OmAsIGVycm9yKTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgY29uc29sZS5sb2coYEluc3RhbmNlICR7aW5zdGFuY2UuSW5zdGFuY2VJZH0gYWxyZWFkeSBpbiBjb3JyZWN0IHN0YXRlIGZvciBhY3Rpb24gJHthY3Rpb259IChjdXJyZW50OiAke2luc3RhbmNlU3RhdGV9KWApO1xyXG4gIH1cclxufVxyXG4iXX0=